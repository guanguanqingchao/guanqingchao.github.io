
![image](https://github.com/guanguanqingchao/guanqingchao.github.io/blob/master/net1.png)

# 一、 Web浏览器生成消息
## 生成http请求消息
- 浏览器解析网址，生成http消息。URI，http，请求行，消息体，状态码，

      http://user:password@www.glasscom.com:80/dir/file1.html
      协议   用户密码可省略   web服务器域名    端口号可省略   文件路径
      
      端口号可以识别到某台具体计算机上的具体套接字
      
      
      http://www.lab.glasscom.com/dir1/file1.html
                      |
                  web服务器名
                  
## dns服务器查询ip地址
- TCP/IP 网络是通过 IP 地址来确定通信对象，ip地址就是服务器的位置

      IP地址是一串32位比特的数字【4字节】，按照8比特为一组分成四组，分别用十进制表示 然后再用圆点隔开
      
      IP主体的表示方法
      10.11.12.13
      
      采用与IP地址主题相同的格式表示子网掩码
      10.11.12.13/255.255.255.0
                     子网掩码
      采用网络号比特数来表示子网掩码的方法
      10.11.12.13/24
                  子网掩码
      表示子网的地址
      10.11.12.13.0 /24
                  | 
                  主机号部分比特全部为0，这个地址表示的不是单独一台计算机，而是整个子网
      表示子网内广播的地址
      10.11.12.13.255 /24
                   |
                   主机部分比特全部为1，这个地址表示对整个子网进行广播
      子网掩码是一 串与 IP 地址长度相同的 32 比特数字，其左边一半都是 1，右边一半都是0。其中，子网掩码为 1 的部分表示网络号，子网掩码为 0 的部分表       示主机号。将子网掩码按照和IP 地址一样的方式以每 8 比特为单位用圆点分组后 写在 IP 地址的右侧，
      
- DNS域名解析，Socket 库提供查询 IP 地址的功能

      浏览器调用解析器，解析器会将取出的 IP 地址写入应 用程序指定的内存地址中
      
- 全世界DNS服务器大接力
      
      DNS 服务器中的所有信息都是按照域名以分层次的结构来保存的
      DNS 中的域名都是用句点来分隔的，比如 www.lab.glasscom.com，这 里的句点代表了不同层次之间的界限
      在域名中，越靠右的 位置表示其层级越高，com 域的下一层是 glasscom 域，再下一层是 lab 域，再下面才是 www 这个名字。
      一个域的信息是作为一个整体存 放在 DNS 服务器中的，不能将一个域拆开来存放在多台 DNS 服务器中
      如何找到 DNS 服务器中存放的信息。这里的关键在于 如何找到我们要访问的 Web 服务器的信息归哪一台 DNS 服务器管。
      
      首先，将负责管理下级域的 DNS 服务器的 IP 地址注 册到它们的上级 DNS 服务器中，然后上级 DNS 服务器的 IP 地址再注册到 更上一级的 DNS 服务器         中，以此类推
      
      负责管理 lab.glasscom.com 这个域的 DNS 服务器的 IP 地址需要注册到 glasscom.com 域的 DNS 服务器中，而 glasscom.com 域的 DNS 服务器的       IP 地址又需要注册到 com 域的 DNS 服务器中。这样，我们就可以通过上级 DNS 服务器查询出下级 DNS 服务器的 IP 地址，也就可以向下级 DNS 服务器发       送查询请求了。
      
      在互联网 中，com 和 jp 的上面还有一级域，称为根域。由于上级 DNS 服务器保管着所有下级 DNS 服务器的信息，所以我们可以从根域开始一路往下顺藤摸瓜       找到任意 一个域的 DNS 服务器。
      
      根域的 DNS 服务器信息保 存在互联网中所有的 DNS 服务器中，分配给根域 DNS 服务器 的 IP 地址在全世界仅有 13 个 A，而且这些地址几乎不发生变化，
      
      如果要查询的域名和相关信息已 经在缓存中，那么就可以直接返回响应，接下来的查询可以从缓存的位置开 始向下进行。相比每次都从根域找起来说，缓存可以减       少查询所需的时间
      
## 委托操作系统 协议栈发送消息

      1. 管道两端的出入口称套接字。首先，服务器一方 先创建套接字，然后等待客户端向该套接字连接管道，当服务器进入等待状态时，客户端就可以连接管道了。具          体来说，客户端也会先创建一个套接字，然后从该套接字延伸出管道，最后管道连接到服务器端的套接字上。 当双方的套接字连接起来之后，通信准备就完成            了。接下来只要将数据送入套接字就可以收发数据了
      2. 当数据全部发送完毕之 后，连接的管道将会被断开。管道在连接时是由客户端发起的，但在断开 时可以由客户端或服务器任意一方发起 A。其中一方断开后，          另一方也会随之 断开，当管道断开后，套接字也会被删除。到此为止，通信操作就结束了
         
          Socket 库
         (1)创建套接字(创建套接字阶段) 
         (2)将管道连接到服务器端的套接字上(连接阶段) connect
         (3)收发数据(通信阶段) write read
         (4)断开管道并删除套接字(断开阶段) close
                                                                                               

# 二、协议栈 网卡： 用电信号传输TCP/IP数据

## 1.创建套接字

![image](https://github.com/guanguanqingchao/guanqingchao.github.io/blob/master/tcp.jpeg)

- 套接字中记录了用于控制通信操作的各种控制信息，协议栈则需要根据这些信息判断下一步的行动，这就是套接字的作用。
- 【协议栈是根据套接字中记录的控制信息来工作的。】
- 浏览器、邮件等一般应用程序收发数据时用 TCP; DNS 查询等收发较短的控制数据时用 UDP。
- IP 中还包括 ICMPA 协议和 ARPB 协议。 ICMP 用于告知网络包传送过程中产生的错误以及各种控制消息，ARP 用于根据 IP 地址查询相应的以太网 MAC 地址 


![image](https://github.com/guanguanqingchao/guanqingchao.github.io/blob/master/socket.jpeg)

## 2.连接服务器

      通信操作中使用的控制信息分为两类。
      (1) 头部中记录的信息 
      (2) 套接字(协议栈中的内存空间)中记录的信息
      
![image](https://github.com/guanguanqingchao/guanqingchao.github.io/blob/master/tcphead.jpeg)
![image](https://github.com/guanguanqingchao/guanqingchao.github.io/blob/master/package.jpeg)

- 连接操作的第一步是在 TCP 模块处创建表示连接控制信息的头部。
- 通过 TCP 头部中的发送方和接收方端口号可以找到要连接的套接字。
- 三次握手
      
      首先，客户端先创建一个包含表示开始数据收发操作的控制信息的头部。
      
      然后，我们将头部中的控制位的 SYN 比特设置为 1，表示连接。此外还需 要设置适当的序号和窗口大小
      
      接下来 TCP 模块会将信息传递给 IP 模块并 委托它进行发送，IP 模块执行网络包发送操作后，网络包就会通过网络到 达服务器，服务器上的 IP 模块会将接       收到的数据传递给 TCP 模块， 服务器的 TCP 模块根据 TCP 头部中的信息找到端口号对应的套接字，就是说，从处于等待连接状态的套接字中找到与 TCP 头       部中记录的端口号 相同的套接字。
      
      找到对应的套接字之后，套接字中会写入相应的信息，并将状态改为正在连接
      
      服务器的 TCP 模块会返回响应，这个过程和客户端一样，需要在 TCP 头部中设置发送方和接收方端口号以及 SYN 比特。此外，在返回响应时还需要将 ACK 控       制位设为 1，这表示已经接收到相应的网络包。网络中经常会发生错误，网络包也会发生丢失，因此双方在通信时必须相互确认网络包是否已经送达，而设置 ACK       比特就是用来进行这一确认的。接下来，服务器 TCP 模块会将 TCP 头部传递给 IP 模块，并委托 IP 模块向客户端返回响应
      
      网络包就会返回到客户端，通过 IP 模块到达 TCP 模块，并通 过 TCP 头部的信息确认连接服务器的操作是否成功。如果 SYN 为 1 则表示连接成功，这时会       向套接字中写入服务器的 IP 地址、端口号等信息，同时还会将状态改为连接完毕。到这里，客户端的操作就已经完成，但其实还 剩下最后一个步骤。刚才服务器       返回响应时将 ACK 比特设置为 1，相应地， 客户端也需要将 ACK 比特设置为 1 并发回服务器，告诉服务器刚才的响应 包已经收到。当这个服务器收到这个返       回包之后，连接操作才算全部完成。


      服务器的 TCP 模块会返回响应，这个过程和客户端一样，需要在 TCP 头部中设置发送方和接收方端口号以及 SYN 比特。此外，在返回响应时还需要将 ACK 控       制位设为 1，这表示已经接收到相应的网络包。网络中经常会发生错误，网络包也会发生丢失，因此双方在通信时必须相互确认网络包是否已经送达，而设置 ACK       比特就是用来进行这一确认的。接下来，服务器 TCP 模块会将 TCP 头部传递给 IP 模块，并委托 IP 模块向客户端返回响应
      
## 3.收发数据

      MTU:一个网络包的最大长度，以太网中一般为 1500 字节。 
      MSS:除去头部之后，一个网络包所能容纳的 TCP 数据的最大长度。
      
![image](https://github.com/guanguanqingchao/guanqingchao.github.io/blob/master/dividie.jpeg)

- 发送缓冲区中的数据就会超过 MSS 的长度，发送缓冲区中的数据会被以 MSS 长度为 单位进行拆分，拆分出来的每块数据会被放进单独的网络包中
- 在每一块数据前面加上 TCP 头部，并根据套接字中记录的控制信息标记发送方和接收方的端口号，然后交给 IP 模块来执行发送数据的操作
- 拆包中ack和序号：通过“序号”和“ACK 号”可以确认接收方是否收到了网络包。
- 重传机制：根据网络包平均往返时间调整 ACK 号等待时间

      具体来说，TCP 会在发送数据 的过程中持续测量 ACK 号的返回时间，如果 ACK 号返回变慢，则相应 延长等待时间;相对地，如果 ACK 号马上就能返回，则相       应缩短等待时间
      
      使用窗口有效管理 ACK 号：
      所谓滑动窗口，就是在发送一个包之后，不等待 ACK 号返回，而是直接发送后续的一系列包。这样一来，等待 ACK 号的这段时间就被有效利用起来了。
      接收方需要告诉发送方自己最多能接收多少数据， 然后发送方根据这个值对数据发送操作进行控制，这就是滑动窗口方式的 基本思路。
      能够接收的最大数据量称为窗口大小
     
     
![image](https://github.com/guanguanqingchao/guanqingchao.github.io/blob/master/ack.jpeg)
![image](https://github.com/guanguanqingchao/guanqingchao.github.io/blob/master/window.jpeg)

## 4.从服务器断开并删除套接字

- 四次断手

      (1)客户端发送 FIN 
      (2)服务器返回 ACK 号 
      (3)服务器发送 FIN 
      (4)客户端返回 ACK 号
      
![image](https://github.com/guanguanqingchao/guanqingchao.github.io/blob/master/wholetcp.jpeg)

## 5.IP与以太网的包收发操作

      TCP 模块在执行连接、收发、断开等各阶段操作时，都需要委托 IP 模块将数据封装成包发送给通信对象。
      
      IP 模块负责添加如下两个头部。
      (1) MAC 头部48bite:以太网用的头部，包含 发送接收MAC 地址，以太类型。
      (2) IP 头部32bite:IP 用的头部，包含 IP 地址/本号、头部长度、总长度、分片偏移量、发送方接收方IP地址等.IP地址分配给网卡，通过IP地址可以判断包           将要发到哪里。IP 模块根据路由表 Gateway 栏的内容判断应该把包发送给谁。
      
      
      封装好的包会被交给网络硬件，网络硬件可能是插在计算机主板上的板卡，也可能是笔记本电脑上的 PCMCIA 卡，或者是计算机主板上集成的芯片，将它们统称为       网卡 。传递给网卡的网络包是由一连串 0 和 1 组成的数字信息，网卡会将这些数字信息转换为电信号或光信号，并通过网线(或光纤)发送出去，然后这些信号         就会到达集线器、路由器等转发设备，再由转发设备一步一步地送达接收方
      
      在以太网中，有一种叫作广播的方法，可以把包发给连接在同一以太网中的所有设备，用ARP查询MAC地址
      
      (1)路由器根据目标地址判断下一个路由器的位置,路由器是按照 IP 规则传输包的设备
      (2)集线器在子网中将网络包传输到下一个路由,集线器是按照以太网规则传输包的设备
      
      MAC头部  IP头部  TCP头部  数据块
        |       |    发送接收端口号、序号、ACK号
        |   目的服务器地址
      下一个路由地址
     
      设置发送方 IP 地址时， 我们已经判断出了从哪块网卡发送这个包，那么现在只要将这块网卡对应 的 MAC 地址填进去就好了。
      
      
      以太网：本质就是一根网线
      收发器：将不同网线之间的信号连接起来
      
      网卡驱动从 IP 模块获取包之后，会将其复制到网卡内的缓冲区中，然后向 MAC 模块发送发送包的命令
      MAC模块会将包从缓冲区中取出，并在开头加上报头和起始帧分界符，在末尾加上用于检测错误的帧校验序列，通过时钟测量读取信号的时机，报头开始将数字信息           按每个比特转换成电信号，将数字信息转换为电信号的速率就是网络的传输速率，例如每秒将 10 Mbit 的数字信息转换为电信号发送出去，则速率就是 10           Mbit/s。
      
      加上报头、起始帧分界符和 FCS 之后，我们就可以将包通过网线发送出去了。发送信号的操作分为两种，一种是使用集线器的半双工 模式，另一种是使用交换机全       双工模式。
      
        


# 集线器 交换机 路由器：从网线到网络设备


# 接入网 网络运营商：通过接入网进入互联网内部
# 防火墙 缓存服务器：服务端局域网的玄机
# web服务器
